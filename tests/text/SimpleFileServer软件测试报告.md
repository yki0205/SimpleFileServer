# SimpleFileServer软件测试报告

## 测试目的

通过设计合理的测试用例，验证SimpleFileServer所有功能的正确性和稳定性；测试用例确保每个分支路径都被测试覆盖，实现对功能逻辑的完整性验证。

## 测试计划

✅验证SimpleFileServer软件的接口是否符合预期功能

✅确保接口在正常与异常情况下均能正确响应

❓发现一些软件设计的缺陷：我们应该加强防止非法访问、数据错误等安全问题的处理，提高系统健壮性。

## 测试环境、工具和组件

| 测试环境 | Node.js (v22.11.0) | 运行后端，进行接口测试       |
| -------- | ------------------ | ---------------------------- |
| 测试框架 | Jest (29.7.0)      | 编写和执行测试，断言测试结果 |
| HTTP测试 | Supertest (7.1.1)  | 模拟HTTP请求，发起接口调用   |

- 环境配置

```
npm install --save-dev jest @testing-library/react @testing-library/jest-dom @testing-library/user-event @types/jest ts-jest

// 因为Jest 28+ 版本不再默认包含 jest-environment-jsdom，需要单独安装
npm install --save-dev jest-environment-jsdom

// e2e测试环境配置（端到端测试时需要）
npm install --save-dev cypress @testing-library/cypress

// 验证是否安装成功
npm install --save-dev \
  jest \
  @testing-library/react \
  @testing-library/jest-dom \
  @testing-library/user-event \
  @types/jest \
  ts-jest \
  jest-environment-jsdom \
  cypress \
  @testing-library/cypress
```

## 测试策略

- **白盒测试：**针对接口函数进行用例设计，确保每个分支路径都被测试覆盖；
- **输入边界值分析：**针对边界值进行用例测试，确保系统正确性；
- **非法输入：**针对非法路径及无效路径进行测试，确保系统的稳定性；

## 测试项成败标准

- 每项功能必须在正常调用下返回`status:200`的状态码；
- 非法路径访问时必须返回非200的状态提示码；
- 必须通过一定规模的用例才算功能正常；

## 风险与应对措施

| 风险点             | 影响             | 应对措施                       |
| ------------------ | ---------------- | ------------------------------ |
| 测试文件过大       | 测试执行缓慢     | 准备中等规模测试集，分阶段测试 |
| 环境配置不一致     | 测试结果不可复现 | 统一测试环境                   |
| 自动化测试用例失败 | 缺陷定位困难     | 增加日志输出，分模块调试       |

## 测试**Text ⽂本⽂件预览**功能

### 待测功能

1. **支持格式**

   - [x] text类型文件（包含.txt、.md等文件类型）

   **功能实现**

   - [x] 代码高亮（基于[react-syntax-highlighter](https://github.com/react-syntax-highlighter/react-syntax-highlighter)）

   - [x] 控制部分：下载按钮、关闭预览按钮

### **单元测试** (针对独立模块/函数)

单元测试分别需要为三个文件测试：PreviewBase、Utils和TextPreview。因为TextPreview和后续的VideoPreview都是继承自PreviewBase或调用到Utils里面的操作。

- **测试框架**：Jest + React Testing Library

- **测试策略**：
- 采用白盒测试方法，验证13个核心交互逻辑

- 使用Jest mock隔离所有子组件依赖

- 覆盖键盘/鼠标/触摸三类输入方式

1. `PreviewBase` 基础预览组件

   **测试用例表**：

   | 用例ID | 使用场景                 | 预期结果                                 |
   | ------ | ------------------------ | ---------------------------------------- |
   | 01     | 基础渲染                 | 显示标题和所有控制按钮                   |
   | 02     | 关闭按钮点击             | 触发onClose回调                          |
   | 03     | 下载按钮点击             | 触发onDownload回调                       |
   | 04     | 全屏切换按钮             | 触发onFullScreenChange回调（true/false） |
   | 05     | 方向切换按钮             | 触发onDirectionChange回调（'rtl'/'ltr'） |
   | 06     | 缩放控制按钮             | 分别触发onZoomIn/onZoomOut回调           |
   | 07     | 导航控制按钮             | 分别触发onPrev/onNext回调                |
   | 08     | 鼠标滚轮控制             | Ctrl+滚轮触发缩放，普通滚轮触发导航      |
   | 09     | 触摸事件处理             | 左滑触发导航，捏合手势触发缩放           |
   | 10     | 键盘事件处理             | 方向键触发导航，ESC退出全屏              |
   | 11     | 全屏模式下的自动隐藏控制 | 不活动时控制按钮应隐藏                   |
   | 12     | 加载状态显示             | 显示Loading组件及自定义消息              |
   | 13     | 错误状态显示             | 显示Error组件及自定义消息                |
   | 14     | 处理空标题情况           | 标题区域应为空DOM元素                    |

   **测试用例示例**：

   ```tsx
   // 导航控制按钮测试
   it('should handle navigation controls', () => {
       render(<PreviewBase {...defaultProps} />);
       
       fireEvent.click(screen.getByRole('button', { name: /ChevronLeft/ }));
       expect(mockOnPrev).toHaveBeenCalledTimes(1);
       
       fireEvent.click(screen.getByRole('button', { name: /ChevronRight/ }));
       expect(mockOnNext).toHaveBeenCalledTimes(1);
     });
   ```

2. `Utils` 辅助工具组件

   **测试用例表：**

    **1. getPreviewType 测试用例**

   | 用例ID |      测试场景      |           输入参数           | 预期输出  |   测试类型   |
   | :----: | :----------------: | :--------------------------: | :-------: | :----------: |
   |   01   |   识别纯文本类型   |        `'text/plain'`        | `'text'`  | 基础功能测试 |
   |   02   |  识别Markdown类型  |      `'text/markdown'`       | `'text'`  | 边界条件测试 |
   |   03   |    识别PDF类型     |     `'application/pdf'`      |  `'pdf'`  | 核心功能测试 |
   |   04   | 识别EPUB电子书类型 |     `'application/epub'`     | `'epub'`  | 扩展功能测试 |
   |   05   | 识别漫画压缩包类型 |     `'application/cbz'`      | `'comic'` | 特殊格式测试 |
   |   06   |  处理未知MIME类型  | `'application/octet-stream'` | `'other'` | 异常处理测试 |

   **2. formatFileSize 测试用例**

   | 用例ID |      测试场景       |   输入参数   |   预期输出    |   测试类型   |
   | :----: | :-----------------: | :----------: | :-----------: | :----------: |
   |   01   |     格式化0字节     |     `0`      |  `'0 Bytes'`  | 边界条件测试 |
   |   02   | 格式化字节到KB转换  |    `1024`    |   `'1 KB'`    | 单位转换测试 |
   |   03   | 格式化字节到MB转换  |  `1048576`   |   `'1 MB'`    | 单位转换测试 |
   |   04   | 格式化字节到GB转换  | `1073741824` |   `'1 GB'`    | 单位转换测试 |
   |   05   | 格式化不足1KB的大小 |    `500`     | `'500 Bytes'` |  小数位测试  |
   |   06   | 格式化带小数位的KB  |    `1500`    |  `'1.46 KB'`  | 精度计算测试 |

   **关键代码片段**：

   ```tsx
   // 文件类型测试
   describe('getPreviewType', () => {
     it('returns correct preview type for MIME types', () => {
       expect(getPreviewType('text/plain')).toBe('text');
       expect(getPreviewType('text/markdown')).toBe('text');
       expect(getPreviewType('application/pdf')).toBe('pdf');
       expect(getPreviewType('application/epub')).toBe('epub');
       expect(getPreviewType('application/cbz')).toBe('comic');
       expect(getPreviewType('application/octet-stream')).toBe('other');
     });
   });
   ```

3. `TextPreview` 文本预览组件

   **测试用例表：**

   | 用例ID |       测试场景描述       |                           测试步骤                           |                   预期结果                   |
   | :----: | :----------------------: | :----------------------------------------------------------: | :------------------------------------------: |
   |   01   | 渲染带语法高亮的文本内容 | 1. 渲染带有效内容和`.js`扩展名的组件<br>2. 检查高亮容器和内容 | 1. 应显示语法高亮容器<br>2. 内容文本正确显示 |
   |   02   |       错误状态显示       |    1. 设置`hasError=true`和自定义错误信息<br>2. 渲染组件     |   1. 显示错误消息容器<br>2. 不显示代码内容   |
   |   03   |       加载状态显示       |       1. 设置`isLoading=true`和加载提示<br>2. 渲染组件       |    1. 显示加载指示器<br>2. 不显示代码内容    |
   |   04   | PreviewBase下载按钮点击  |         1. 传入下载回调函数<br>2. 点击模拟的下载按钮         |            下载回调函数被调用1次             |
   |   05   |     头部下载按钮点击     |    1. 传入文件名和下载回调<br/>2. 查找并点击头部下载按钮     |            下载回调函数被调用1次             |

   **测试代码示例**：

   ```tsx
   // 语法高亮渲染测试
   it('renders text content with syntax highlighting', () => {
     render(<TextPreview isOpen={true} content={sampleText} fileExtension=".js" />);
     
     const codeContent = screen.getByTestId('code-content');
     expect(codeContent).toHaveTextContent('# Sample Text');
     expect(screen.getByTestId('syntax-highlighter')).toBeInTheDocument();
   });
   ```

### **集成测试**（`integration/TextPreview.test.tsx`）

集成测试重点验证了以下交互场景：

1. **组件协同工作**：确认TextPreview与PreviewBase的继承关系正确实现，所有基础控制功能（如下载、关闭按钮）在集成环境中保持可用性
2. **第三方库集成**：验证react-syntax-highlighter库与自定义样式的兼容性，特别是：
   - 不同文件扩展名(.js/.md等)触发对应语法高亮规则
   - 长文本渲染时的滚动条行为

| 用例ID |      测试场景      |                      测试步骤                      |                    预期结果                    |
| :----: | :----------------: | :------------------------------------------------: | :--------------------------------------------: |
|   01   | 语法高亮器集成验证 | 1. 渲染带Markdown内容的组件<br>2. 检查语法高亮容器 | 1. 正确渲染代码高亮容器<br>2. 内容文本完整显示 |
|   02   |  下载按钮交互集成  |   1. 传入下载回调函数<br>2. 模拟用户点击下载按钮   |       1. 按钮可点击<br>2. 回调函数被触发       |

### 测试结果

- 手动测试

  ![1](F:\桌面\测试计划文档.assets\1.png)

![3](F:\桌面\测试计划文档.assets\3.png)

从前两个图中，显示可以访问预览text类型文件，并且有显示代码高亮。（针对没有办法预览的文件类型，会推荐用户将文档下载到本地阅读。例如以下的对话框呈现：

![4](F:\桌面\测试计划文档.assets\4.png)

针对控制部分（文件名同一行的右上角两个功能——下载和关闭功能，通过操作均能正确实现，但是对于某些中文字通过下载阅读器查看时，文字会错乱无法阅读，这部分仍待修正）

![5](F:\桌面\测试计划文档.assets\5.png)

![2](F:\桌面\测试计划文档.assets\2.png)

- 代码案例测试

  **单元测试**

  **PreviewBase.test.tsx 基础预览测试**

  为了后续继承的其他Preview，先进行测试基类的PreviewBase实现。

  ```sh
  npm test PreviewBase.test.tsx
  ```

  <img src="F:\桌面\测试计划文档.assets\13.png" alt="10" style="zoom:25%;" align='left'/> 

  <img src="F:\桌面\测试计划文档.assets\14.png" alt="14" style="zoom:25%;" />

  可以从结果中看到测试用例中，大多数能够正确的处理完成，测试成功，但有两个失败，分别是：

  - 测试用例11：全屏模式下的自动隐藏控制（按钮未按预期隐藏）
  - 测试用例14：处理空标题情况（未找到preview-header元素）

  失败用例的技术归因：

  - **空标题处理失败**：检测发现`preview-header`元素未按预期设置为空DOM元素，原因是条件渲染逻辑错误，提醒开发修改后就可以处理了。

  - **自动隐藏控制栏**：测试环境与真实浏览器环境差异导致：

    - Jest定时器模拟不完整
    - 需增加`jest.useFakeTimers()`并手动推进时间

    这部分需要在我的测试代码中再修改一部分，跟着项目修改后再次测试，但是由于这个部分的实现在我的测试中不影响，所以暂时不处理）

  **Utils.test.tsx 辅助工具测试 和 TextPreview.test.tsx 文本文件预览测试**

  <img src="F:\桌面\测试计划文档.assets\15.png" alt="15" style="zoom:25%;" />

  两者皆测试样例全部通过（图片中的是所有测试样例的总结显示，failed在别的用例）

- **集成测试**

  <img src="F:\桌面\测试计划文档.assets\17.png" alt="17" style="zoom:30%;" />

  测试用例都通过了。不过这部分目前编写的测试样例不足，后续可以继续补充，设计更多更全面的测试，例如边界性、异常输入处理等测试。

## 测试**Video 视频预览**功能

**支持格式**

- [x] .mp4、.mkv

**功能实现**

- [x] 全屏模式
- [x] 画中画模式
- [x] 鼠标/触控支持（单击进度条跳转、拖拽进度条跳转、左右滑动视频跳转、双击视频中区进行播放/暂停、双击视频右/左侧快进/快退）
- [x] 键盘支持（空格键播放/暂停、左右方向键快退/快进10秒、F键切换全屏、M键静音/取消静音、Esc键退出全屏）
- [x] 控制栏
  - [x] 视频进度条（进度条拖拽时显示跳转时刻、当前时间/总时长显示）
  - [x] 各类控制按钮：播放/暂停按钮、全屏/退出全屏按钮、画中画按钮、调节播放速度菜单
- [x] 其它：音量和亮度指示器、快进/后退时连续操作的累计时间显示、键盘快捷键帮助显示

视频组件测试设计的特殊考量：

1. **浏览器API模拟**：使用jest.mock对全屏/画中画API进行模拟，解决测试环境限制问题
2. **跨输入方式兼容**：测试键盘快捷键与触摸事件并存时的冲突处理机制

### 测试用例

| 用例ID |     测试场景描述     |                 测试步骤                 |                       预期结果                        |
| :----: | :------------------: | :--------------------------------------: | :---------------------------------------------------: |
|   01   | 正确加载MP4格式视频  | 1. 传入MP4格式视频URL<br>2. 等待加载完成 |    1. 视频元素src属性正确设置<br>2. 不显示错误提示    |
|   02   | 正确加载MKV格式视频  | 1. 传入MKV格式视频URL<br>2. 等待加载完成 |    1. 视频元素src属性正确设置<br>2. 不显示错误提示    |
|   03   | 处理不支持的视频格式 | 1. 传入AVI格式视频URL<br>2. 等待加载完成 |       1. 显示错误提示组件<br>2. 不显示视频元素        |
|   04   |  响应播放/暂停操作   |             1. 点击播放按钮              |                 1. 触发onNext回调函数                 |
|   05   |     切换全屏模式     |             1. 点击全屏按钮              |    1. 触发onFullscreen回调<br>2. 全屏按钮保持可见     |
|   06   |    切换画中画模式    |              1. 点击PIP按钮              | 1. 触发onPictureInPicture回调<br>2. 调用浏览器PIP API |
|   07   |  响应进度条点击跳转  |          1. 点击进度条任意位置           |                 1. 触发onNext回调函数                 |
|   08   | 响应空格键播放/暂停  |            1. 按下键盘空格键             |                 1. 触发onNext回调函数                 |
|   09   | 响应方向键快进/快退  |            1. 按下左/右方向键            |                 1. 进度条组件保持可见                 |
|   10   |   响应F键全屏切换    |              1. 按下键盘F键              |                  1. 全屏按钮保持可见                  |
|   11   |   响应M键静音切换    |              1. 按下键盘M键              |                  1. 视频元素保持可见                  |
|   12   |     响应音量调节     |            1. 按下上/下方向键            |                  1. 视频元素保持可见                  |
|   13   |     响应亮度调节     |         1. 按下Ctrl+上/下方向键          |                  1. 视频元素保持可见                  |
|   14   |   响应播放速度调节   |             1. 按下`.`/`,`键             |                  1. 视频元素保持可见                  |
|   15   |   响应触控滑动跳转   |           1. 横向滑动视频区域            |                 1. 进度条组件保持可见                 |
|   16   |   响应滚轮音量调节   |        1. 在右侧区域滚动鼠标滚轮         |                  1. 视频元素保持可见                  |
|   17   |    自动隐藏控制栏    |             1. 等待4秒无操作             |              1. 控制栏保持可见（需修正）              |
|   18   |  显示键盘快捷键帮助  |              1. 按下键盘H键              |                  1. 视频元素保持可见                  |
|   19   |    卸载时清理资源    |    1. 渲染播放中的组件<br>2. 执行卸载    |               1. 调用video.pause()方法                |

### 测试结果

- **手动测试**

  以下展示了视频播放（mp4格式）以及进度条呈现以及各个操作图示：

  <img src="F:\桌面\测试计划文档.assets\6.png" alt="6" style="zoom:12%;" />

  全屏模式、快转播放：

  <img src="F:\桌面\测试计划文档.assets\7.png" alt="7" style="zoom:9%;" />  

  <img src="F:\桌面\测试计划文档.assets\9.png" alt="7" style="zoom:9%;" />

  

  由于视频预览的功能繁多，有些无法单纯依赖图片展示，因此这里只展现一部分，后续详细的可以从项目报告视频里查看。

- **代码案例测试**

  通过`npm test VideoPreview.test.tsx`来运行测试：

  <img src="F:\桌面\测试计划文档.assets\11.png" alt="11" style="zoom:24%;" align='left'/>

  <img src="F:\桌面\测试计划文档.assets\12.png" alt="12" style="zoom:24%;" />     

  从结果中可以看出，19个测试样例中，有3个测试失败，其中分别是以下功能：

  -  测试用例6：画中画模式
  -  测试用例8：响应空格键播放/暂停
  -  测试用例19：卸载时清理资源

  这三个测试用例的失败技术解析是：

  | 问题用例                   | 根本原因                                         |
  | -------------------------- | ------------------------------------------------ |
  | 画中画模式                 | 导入方式错误，需要再修正                         |
  | 空格键控制                 | 键盘事件未正确传递到视频组建、事件冒泡被意外阻止 |
  | 资源清理（卸载时清理资源） | 没有实现这方面的操作，需要补充                   |

  经过将测试结果以及原因可能需要修改的部分提供给开发后，已经修正了画中画模式，其余2个测试用例仍在修正中。

## 测试文件搜索功能

- 关键词搜索；
- 分页查询（`page`、`limit`参数）；
- 排序功能（根据`name`、`time`排序）；
- 越权访问控制

### 测试用例（所有编号的测试用例下会更换输入参数重复测试5-10次）

| 编号 | 测试点                       | 输入参数                                       | 预期输出结果                                   |
| ---- | ---------------------------- | ---------------------------------------------- | ---------------------------------------------- |
| TS-1 | 正常搜索                     | `query=abc`                                    | 返回状态码`200`，body中results是数组；         |
| TS-2 | 缺少`query`参数              | 无                                             | 返回状态码`400`，并在body中给出错误提示；      |
| TS-3 | 分页参数测试                 | `query=comic`、`page=1`、`limit=1`             | 返回状态码`200`，最终返回结果不超过`limit`条； |
| TS-4 | 排序功能测试                 | `query=comic`、`sortBy=name`、`sortOrder=desc` | 返回状态码`200`                                |
| TS-5 | 越权目录访问测试(权限)       | `query=abc`、`dir=../etc`                      | 返回状态码>=400，安全拦截                      |
| TS-6 | 分页参数异常（page=-1）      | `query=comic`、` page=-1`、`limit=10`          | 返回状态码`200`，正常处理异常参数              |
| TS-7 | 索引搜索与实时搜索结果一致性 | `query=comic`                                  | `total`字段值相同，搜索结果数量一致            |

### 测试结果

| 编号 | 测试点                       | 输入参数                                       | 实际输出结果                                   | 与预期结果是否一致 | 结论       |
| ---- | ---------------------------- | ---------------------------------------------- | ---------------------------------------------- | ------------------ | ---------- |
| TS-1 | 正常搜索                     | `query=abc`                                    | 返回状态码`200`，body中results是数组；         | 一致               | 通过       |
| TS-2 | 缺少`query`参数              | 无                                             | 返回状态码`400`，并在body中给出错误提示；      | 一致               | 通过       |
| TS-3 | 分页参数测试                 | `query=comic`、`page=1`、`limit=1`             | 返回状态码`200`，最终返回结果不超过`limit`条； | 一致               | 通过       |
| TS-4 | 排序功能测试                 | `query=comic`、`sortBy=name`、`sortOrder=desc` | 返回状态码`200`                                | 一致               | 通过       |
| TS-5 | 越权目录访问测试(权限)       | `query=abc`、`dir=../etc`                      | 返回状态码=200，成功访问                       | **不一致**         | **不通过** |
| TS-6 | 分页参数异常（page=-1）      | `query=comic`、`page=-1`、`limit=10`           | 返回状态码`200`，正常处理异常参数              | 一致               | 通过       |
| TS-7 | 索引搜索与实时搜索结果一致性 | `query=comic`                                  | `total`字段值相同，搜索结果数量一致            | 一致               | 通过       |

整体测试情况：

![c5128bf3201c4645d0496d7d9a51f4b](F:\桌面\测试计划文档.assets\c5128bf3201c4645d0496d7d9a51f4b.png)

不通过的用例返回情况：

![686729180c7908253ace5b44cb9afe5](F:\桌面\测试计划文档.assets\686729180c7908253ace5b44cb9afe5.png)

- 本次测试覆盖了文件搜索接口的主要正常路径与关键异常路径，基本功能测试通过，系统功能得到保证；
- 文件搜索功能本地测试时多次运行结果与多个用例一致，接口无崩溃，无未捕获异常；

## 测试comic动画文件预览功能

- `.cbz`文件的解析；

- `.cbr`文件的解析；
- 非法文件格式的处理；
- 非法路径的处理；
- 图像文件的键盘功能(双指缩放、双击重置缩放、滚轮导航等)；

### 测试用例

| 编号 | 测试点                   | 输入参数              | 预期输出结果                            |
| ---- | ------------------------ | --------------------- | --------------------------------------- |
| TC-1 | 正确解析`.cbz`文件       | `comic/test.cbz`      | 返回状态码`200`，返回体中为数组         |
| TC-2 | 正确解析`.cbr`文件       | `comic/test.cbr`      | 返回状态码`200`，返回体中为数组         |
| TC-3 | 正确处理不支持的文件格式 | `comic/test.docx`     | 返回状态码`400`，表示格式不支持         |
| TC-4 | 文件不存在的情况         | `comic/missing.cbz`   | 返回状态码`404`，提示找不到文件         |
| TC-5 | 非法路径穿越尝试         | `../../../secret.cbz` | 返回状态码`403/404`，防止访问非授权文件 |

### 测试结果

| 编号 | 测试点                   | 输入参数              | 输出结果                                | 与预期结果是否一致 | 结论   |
| ---- | ------------------------ | --------------------- | --------------------------------------- | ------------------ | ------ |
| TC-1 | 正确解析`.cbz`文件       | `comic/test.cbz`      | 返回状态码`200`，返回体中为数组         | 一致               | 通过   |
| TC-2 | 正确解析`.cbr`文件       | `comic/test.cbr`      | 返回状态码`200`，返回体中为数组         | 一致               | 通过   |
| TC-3 | 正确处理不支持的文件格式 | `comic/test.docx`     | 返回状态码`400`，表示格式不支持         | 一致               | 通过   |
| TC-4 | 文件不存在的情况         | `comic/missing.cbz`   | 返回状态码`404`，提示找不到文件         | 部分一致           | 不通过 |
| TC-5 | 非法路径穿越尝试         | `../../../secret.cbz` | 返回状态码`403/404`，防止访问非授权文件 | 一致               | 通过   |

![bf33da0d4526003931cba4920264a49](F:\桌面\测试计划文档.assets\bf33da0d4526003931cba4920264a49.png)

虽然`TC-2`整体测试通过，但是针对于不同的`.cbr`文件，其表现出部分通过的情况，因此该功能异常。

本次测试覆盖了漫画接口的所有分支路径，漫画基本功能测试通过，系统基本功能得到保证；

## 测试image文件预览功能

### 测试用例

| 编号  | 测试名称      | 输入文件  | 预期结果               | 操作步骤                                                     | 特殊断言                                            |
| ----- | ------------- | --------- | ---------------------- | ------------------------------------------------------------ | --------------------------------------------------- |
| TF-01 | PNG 图像预览  | test.png  | 预览窗口弹出，图片可见 | 打开 images → 点击 test.png->ArrowRight/Left->mouse.wheel->Enter->Escape | `img[alt="Preview"]` 可见，并通过所有模拟点击不报错 |
| TF-02 | JPG 图像预览  | test.jpg  | 同上                   | 打开 images → 点击 test.jpg->ArrowRight/Left->mouse.wheel->Enter->Escape | 同上                                                |
| TF-03 | JPEG 图像预览 | test.jpeg | 同上                   | 打开 images → 点击 test.jpeg->ArrowRight/Left->mouse.wheel->Enter->Escape | 同上                                                |
| TF-04 | GIF 图像预览  | test.gif  | 动图可播放             | 打开 images → 点击 test.gif->ArrowRight/Left->mouse.wheel->Enter->Escape | 同上                                                |
| TF-05 | CBZ 预览      | test.cbz  | 解压后展示第一页       | 打开 comic → 点击 test.cbz->ArrowRight/Left->mouse.wheel->Enter->Escape | `img` 存在并可见                                    |
| TF-06 | CBR 预览      | test.cbr  | 解压后展示第一页       | 打开 comic → 点击 test.cbr->ArrowRight/Left->mouse.wheel->Enter->Escape | 同上                                                |

### 测试结果

| 编号  | 测试名称      | 输入文件  | 预期结果               | 与预期结果是否一致 | 结论 |
| ----- | ------------- | --------- | ---------------------- | ------------------ | ---- |
| TF-01 | PNG 图像预览  | test.png  | 预览窗口弹出，图片可见 | 一致               | 通过 |
| TF-02 | JPG 图像预览  | test.jpg  | 同上                   | 一致               | 通过 |
| TF-03 | JPEG 图像预览 | test.jpeg | 同上                   | 一致               | 通过 |
| TF-04 | GIF 图像预览  | test.gif  | 动图可播放             | 一致               | 通过 |
| TF-05 | CBZ 预览      | test.cbz  | 解压后展示第一页       | 一致               | 通过 |
| TF-06 | CBR 预览      | test.cbr  | 解压后展示第一页       | 一致               | 通过 |

![1749627794531](F:\桌面\测试计划文档.assets\1749627794531.png)

## 测试PDF预览功能

打开文件、翻页操作、退出预览

### 测试用例与结果

用例1：正常打开PDF文件

**步骤**：

**预期结果**：

- 页面加载PDF预览区域
- 控制台输出"PDF文件打开正常"

**实际结果**：

- iframe元素可见，内容正常渲染
- 控制台输出对应日志
  **状态**：通过

用例2：翻页交互测试

**预期结果**：

- 按键盘→键，按键盘←键，页面切换至下一页/上一页
- 控制台输出"PDF文件翻页正常"

**实际结果**：

- 翻页动画流畅，无卡顿
- 日志正确记录操作
  **状态**：通过

用例3：退出预览测试

**预期结果**：

- 退出预览模式，返回文件列表
- 无页面报错

**实际结果**：

- 成功返回上级目录

- 控制台无异常日志
  **状态**：通过

  ![1](F:\桌面\测试计划文档.assets\11.png)

## 测试EPUB预览功能

格式支持、页面导航、内容渲染

### 用例1：格式兼容性测试

**步骤**：

1. 进入"epub"目录
2. 点击"Sway.epub"文件

**预期结果**：

- 预览容器（.epub-viewer）可见
- 内容段落排版正常

**实际结果**：

- 页面加载epub阅读器
- 文字无乱码，章节显示正确
  **状态**：通过


### 用例2：页面导航测试

**步骤**：

1. 打开EPUB后按→键
2. 等待500ms后按←键

**预期结果**：

- 页面切换时无内容丢失
- 导航按钮响应正常

**实际结果**：

- 翻页时内容平滑过渡

- 控制台输出翻页日志
  **状态**：通过

  ![2](F:\桌面\测试计划文档.assets\22.png)

![屏幕截图 2025-06-14 205004](F:\桌面\测试计划文档.assets\屏幕截图 2025-06-14 205004.png)

## 测试AUDIO文件预览功能

播放控制、倍速调节、格式兼容性

### （一）用例1：MP3播放控制

**步骤**：

1. 进入"audio"目录
2. 点击"中山大学 - 中山大学校歌.mp3"
3. 调用`audio.play()`方法

**预期结果**：

- audio元素可见
- 播放状态为非暂停（isPlaying=true）

**实际结果**：

- 播放器控件正常显示
- 控制台输出"MP3播放正常"
  **状态**：通过


### （二）用例2：倍速调节测试

**步骤**：

1. 播放状态下设置`playbackRate=2.0`
2. 验证速率值

**预期结果**：

- 播放速度变为2倍
- 控制台输出"倍速播放正常"

**实际结果**：

- 音频播放加速无破音
- 速率值检测为2.0
  **状态**：通过


### （三）用例3：多格式兼容性测试

| 测试文件               | 预期结果     | 实际结果 |
| ---------------------- | ------------ | -------- |
| ff-16b-2c-44100hz.aac  | 控件加载     | 同预期   |
| gs-16b-1c-44100hz.flac | 时长>0       | 同预期   |
| gs-16b-1c-44100hz.wav  | 播放状态正常 | 同预期   |

![3](F:\桌面\测试计划文档.assets\33.png)

## 测试文件查看功能

### 测试计划

| 功能模块 | 接口说明                              |
| :------- | :------------------------------------ |
| 文件详情 | `/api/files`                          |
| 文件排序 | `/api/files?sortBy=xxx&sortOrder=xxx` |
| 分页功能 | `/api/files?page=x&limit=y`           |

### 测试用例

#### 测试用例1：获取合法目录下的文件列表

可以看到当请求路径正常的时候可以获取到正常的文件夹下的详情文件

![image-20250610192048072](C:\Users\jhy\AppData\Roaming\Typora\typora-user-images\image-20250610192048072.png)

#### 测试用例2：访问非法路径

可以看到当想要访问完全不存在的文件（非法路径）时，产生了预期的错误码

![image-20250610174405031](C:\Users\jhy\AppData\Roaming\Typora\typora-user-images\image-20250610174405031.png)

这也与app.js（文件服务器后端核心代码文件）代码中的处理信息一致，会返回403并且相关的error信息是Access denied

![image-20250610174519521](C:\Users\jhy\AppData\Roaming\Typora\typora-user-images\image-20250610174519521.png)

#### 测试用例3：文件按名称升序排序

我不光想测试文件的正常展示，我还希望按照我传入的sortBy字段进行展示，基于此我进行了测试，可以看到下面的文件就是按照name排序的

![image-20250610190401269](C:\Users\jhy\AppData\Roaming\Typora\typora-user-images\image-20250610190401269.png)

#### 测试用例4：文件按名称升序排序

![image-20250610191605190](C:\Users\jhy\AppData\Roaming\Typora\typora-user-images\image-20250610191605190.png)

#### 测试用例5：文件按大小降序排序

![image-20250610191709568](C:\Users\jhy\AppData\Roaming\Typora\typora-user-images\image-20250610191709568.png)

#### 测试用例6：分页查看指定数量的文件

当分页查询请求指定page=1,size=2的时候可以看到返回的结果只有两个文件

![image-20250610190525061](C:\Users\jhy\AppData\Roaming\Typora\typora-user-images\image-20250610190525061.png)

## 测试文件操作功能

![image-20250610190751020](C:\Users\jhy\AppData\Roaming\Typora\typora-user-images\image-20250610190751020.png)

#### 测试用例1：文件重命名成功(`/api/rename`)

![image-20250610192434087](C:\Users\jhy\AppData\Roaming\Typora\typora-user-images\image-20250610192434087.png)

#### 测试用例2：文件上传功能

可以看到上传成功 返回ok的200返回码，并且response body中获得了正常上传的文件的相关信息，并且因为是上传文件，所以这里使用的是post方法

![image-20250610174806178](C:\Users\jhy\AppData\Roaming\Typora\typora-user-images\image-20250610174806178.png)

#### 测试用例3：非法文件上传路径

可以看到如果是非法的上传路径，最后的response body就是Access denied

![image-20250610174945542](C:\Users\jhy\AppData\Roaming\Typora\typora-user-images\image-20250610174945542.png)

#### 测试用例4：文件移动

可以看到把uploads文件夹下的文件移入到了new-folder文件夹下

![image-20250610192217272](C:\Users\jhy\AppData\Roaming\Typora\typora-user-images\image-20250610192217272.png)

#### 测试用例5：非法文件移动操作

可以看到如果send的请求不包含正常的sources和destination就会返回响应体：“No Sources Provided"

![image-20250610185914090](C:\Users\jhy\AppData\Roaming\Typora\typora-user-images\image-20250610185914090.png)



## 测试文件索引建立与监控功能

### 测试方法

⽂件监控的主要⽬的为在后端初次启动建⽴⽂件索引后，对后续的⽂件变化进⾏监控，并及时更新索 引。因此，⾃然的我们测试的顺序为：

- 测试后端初始是否能够正确⾼效地建⽴⽂件索引 

- 测试后端是否能够正确监控⽂件变化 

- 测试⽂件监控是否能够及时更新索引

测试方法：创建一个复杂并且包含大量文件的文件结构，然后测试后端是否能够正确建立索引，并且后续对文件结构与文件内容进行修改，测试索引是否能够正确更新。

### 测试用例

| 用例编号 | TEST-01                                                      |
| -------- | ------------------------------------------------------------ |
| 用例名称 | 文件索引建立功能测试                                         |
| 测试步骤 | 1. 配置后端启动文件索引功能，监控索引建立过程资源使用率<br>2. 在索引建立完成后，使用搜索请求测试索引的正确性 |

| 用例编号 | TEST-02                                                      |
| -------- | ------------------------------------------------------------ |
| 用例名称 | 文件监控功能测试                                             |
| 测试步骤 | 1. 配置后端启动文件监控功能，监控文件监控过程资源使用率<br>2. 在文件监控完成后，使用搜索请求测试索引的正确性 |

### 测试步骤

#### 编写测试脚本

测试代码的结构大致如下图所示：

![test-code](F:\桌面\测试计划文档.assets\test-code.png)

该脚本在运行时会根据用户所输入的参数生成一个文件结构，并进行参数批次地对文件结构进行更新与对文件进行修改。

#### 创建测试目录

考虑到电脑的性能限制，我只创建了大约10w个文件，如下：

![test-0](F:\桌面\测试计划文档.assets\test-0.png)

![test-1](F:\桌面\测试计划文档.assets\test-1.png)

### 测试结果

- 文件索引建立正常启动

![test-2](F:\桌面\测试计划文档.assets\test-2.png)

- 文件索引过程资源使用率正常

![test-3](F:\桌面\测试计划文档.assets\test-3.png)

- 文件索引建立完成后，索引文件数符合预期

![test-4](F:\桌面\测试计划文档.assets\test-4.png)

![test-5](F:\桌面\测试计划文档.assets\test-5.png)

- 搜索请求能够正确返回结果

  ![test-6](F:\桌面\测试计划文档.assets\test-6.png)

  ![test-7](F:\桌面\测试计划文档.assets\test-7.png)

- 文件监控正常启动

  ![test-10](F:\桌面\测试计划文档.assets\test-10.png)

- 文件监控正确监测到文件变化

  ![test-11](F:\桌面\测试计划文档.assets\test-11.png)

- 文件监控正确更新索引

  ![test-12](F:\桌面\测试计划文档.assets\test-12.png)

## 覆盖率深度分析

在终端通过`npm test:coverage` 来生成 jest 内包含的覆盖率测试报告（html），从中我们得到以下的结果，可以提供后续持续测试或改进的方向

整体覆盖率趋势：

  - 语句覆盖：67.31% (243/361)

  - 分支覆盖：56.21% (181/322) ← 主要短板

  - 函数覆盖：69.23% (45/65)

  - 行覆盖：68.58% (238/347)

    ![image-20250614214041286](C:\Users\jhy\AppData\Roaming\Typora\typora-user-images\image-20250614214041286.png)

  关键模块表现：

    1. **Preview组件**：覆盖率65.19%，分支覆盖仅54.78%，是主要改进点
    2. **UI组件**：100%覆盖，测试完整
    3. **工具函数(lib)**：100%覆盖，测试完备

## 异常结果总结

### 文件搜索功能

- **安全性：**文件搜索功能**未能有效阻止非法路径访问**，出现越权漏洞；

### 漫画解析功能

- **稳定性/正确性：**`TC-2`测试用例通过，但更换测试输入参数后，发现出现错误的结果，该功能的稳定性和准确性不保证；

| 缺陷用例ID | 问题描述               | 严重级别 | 修复状态 |
| ---------- | ---------------------- | -------- | -------- |
| TS-5       | 非法路径访问成功       | 严重     | 已修复   |
| TC-2       | 部分`.cbr`文件解析失败 | 一般     | 已修复   |

### 文件索引建立与监控功能

- 当存在有大量文件时，后端一次性返回所有结果导致前端接收以及渲染卡顿：

  ![test-8](F:\桌面\测试计划文档.assets\test-8.png)

- 在实际使用中，文件监控可能会监测到不需要的文件变化

### 文件展示的分页功能

可以看到当我们传入非法分页参数的时候（page=-1)，软件没有进行有效校验，导致返回了错误的状态码 `200 OK`，这个设计应该是有缺陷的,即使用户输入了无效值，仍然继续执行查询操作。

基于这个缺陷，我的思考如下：

- 不合理的参数会导致性能问题（如 `limit=999999`），或越界访问（如 `page=-1`），所以我们应该尽早进行有效校验。
- 对所有用户输入都应进行严格校验，防止恶意攻击（如路径穿越、SQL 注入等）。
- 而且分页功能未做边界检查，将会影响所有使用分页功能的接口

![image-20250610190702348](C:\Users\jhy\AppData\Roaming\Typora\typora-user-images\image-20250610190702348.png)

## 改进建议

### 漫画解析功能

- 建议提高漫画文件的兼容性，解决`.cbr`的部分通过异常问题；

### 文件搜索功能

- 建议提高系统安全性，防止非法路径的越权访问，威胁系统安全；

### 文件索引建立与监控功能

- 基于索引机制在后端实现分页机制，后端分批次返回结果，前端分批次展示结果。实现后，请求与展示的耗时均大幅减少：

  ![test-9](F:\桌面\测试计划文档.assets\test-9.png)

- 增加文件监控的过滤机制，只监控需要监控的文件变化：

![test-13](F:\桌面\测试计划文档.assets\test-13.png)

### PDF EPUB AUDIO文件预览功能

- 补充EPUB非标准格式测试（如损坏的epub文件）
- 增加音频音量调节功能测试
- 测试大文件（>100MB）的加载性能

